name: 'Publish to Cloudflare Pages'
description: 'Builds the Hugo site and deploys it to Cloudflare Pages'

inputs:
  cloudflare_api_token:
    description: 'Cloudflare API Token'
    required: true
  cloudflare_account_id:
    description: 'Cloudflare Account ID'
    required: true
  cloudflare_project_name:
    description: 'Cloudflare Pages project name'
    required: true
  branch_name:
    description: 'Branch name to deploy'
    required: false
    default: main
  node_version:
    description: 'Node.js version to use'
    required: false
    default: '20'
  pnpm_version:
    description: 'pnpm version to use'
    required: false
    default: '10'

runs:
  using: "composite"
  steps:
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ inputs.pnpm_version }}
        run_install: false

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
        cache: 'pnpm'

    - name: PNPM install
      shell: bash
      run: pnpm install

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2

    - name: Build
      shell: bash
      run: ./scripts/build.sh

    - name: Deploy to Cloudflare Pages
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ inputs.cloudflare_api_token }}
        accountId: ${{ inputs.cloudflare_account_id }}
        command: pages deploy public --project-name=${{ inputs.cloudflare_project_name }} --branch=${{ inputs.branch_name }}
